---
title: 트랜젝션
---

# 트랜잭션의 개요
## 개념
어플리케이션 개발자 입장에서, 트랜잭션이란 DBMS를 사용하는 가장 큰 이유 중 하나이다.

트랜잭션을 간단히 정의하면 **작업의 최소단위**라고 할 수 있다. 자동적으로 정해져있는 것은 아니며, 개발자가 임의로 작업의 범위를 지정하여 트랜잭션으로 정할 수 있다.

예컨대, 아래와 같은 작업이 수행된다고 하자,  
INSERT A, UPDATE A, SELECT A, INSERT B, UPDATE B, SELECT B, INSERT C, ...  
그렇다면 개발자는 INSERT, UPDATE, SELECT를 하나의 트랜잭션으로 잡을 수 있다.

## 주의사항
한 줄의 SQL문도 트랜잭션으로 잡을 수는 있지만, 보통은 여러 줄의 SQL문을 트랜잭션으로 잡는다.  
SELECT는 데이터베이스에 변화를 가하는 것이 아니기 떄문에 보통은 트랜잭션으로 잡지 않는다.

## 예시
계좌이체가 가장 대표적인 트랜잭션의 예이다.  
A의 계좌에서 B의 계좌로 3000원을 이체한다고 하자. 그렇다면 최소한 아래와 같은 단계가 필요하다.

1. A의 계좌의 존재 여부 확인  
   ... success
2. B의 계좌의 존재 여부 확인  
   ... success
3. A의 잔액을 조회하여 3000원 이상인지 확인  
   ... success / RETURNED 7000
4. A의 잔액을 7000원에서 3000원 감소한 값으로 수정  
   ... success / UPDATED TO 4000
5. B의 잔액을 조회  
   ... success / RETURNED 2000
6. B의 잔액을 3000원을 증가한 값으로 수정  
   ... success / UPDATED TO 5000

## 사용 목적: ACID
트랜잭션을 설정하면 DBMS로부터 다음의 네 가지 특성을 보장받을 수 있다.

### (1) Atomicity 원자성  
**ALL OR NOTING**: 다 하거나 아니면 다 안하거나

위의 1~6 단계에서 4번까지 진행되었으나, 이후 ATM에 전기가 차단된 시나리오를 생각해보자.

A의 계좌에서는 돈이 차감되었으나 B의 계좌에는 돈이 증가하지 않은 상황으로 전산 상의 돈이 증발한 상태이다. 이를 사전에 트랜잭션으로 지정했다면 중간에 오류가 발생하였을 때, 작업을 시작하기 전의 상태로 롤백 ROLL BACK 할 수 있다.

코드로 예외처리하기에는 너무 복잡해지는 작업이므로, DBMS 수준에서 트랜잭션을 거는게 좋다.

### (2)  Consistency 일관성
트랜잭션을 지정하면 모든 단계에서 제약사항이 만족되어야만 한다. 이 과정 중에서 제약사항에 위배되는 경우가 있다면 진행된 모든 작업이 롤백된다.

예컨대 위의 예시에서는 계좌 잔액이 음수가 되지 않도록 일관되게 유지할 수 있다.

### (3)  Isolation 독립성
위의 예시에서 A가 B에게 이체를 할 때, 제 3자인 C도 B에게 3000원의 이체를 요청했다고 하자. 이때, B의 이전 잔액인 2000원을 기준으로 UDPATE가 수행되어 B계좌의 잔액이 예상되는 값인 8000원이 아니라 5000원이 될 가능성이 있다.

이 과정을 트랜잭션으로 잡으면, 동시 요청이 블록되어 이러한 일을 막을 수 있다. 코드로 구현하려면 까다로운 기능이므로 트랜잭션을 거는게 좋다.

### (4)  Durability 영속성
트랜잭션의 결과가 메모리 상에만 존재하는 것이 아니라, 2차 영구 장소에 저장되는 것을 DBMS가 보장해준다. 즉, 트랜잭션으로 걸면 그 결과가 날라가지 않는 다는 것을 DBMS가 보장한다.

사용하지 않을 이유가 없으므로, 프로그램 개발 단계에서 트랜잭션을 꼭 설정해주는 것이 좋다.

# 트랜잭션 실습
- START TRANSACTION;
- 작업 수행
- COMMIT; 혹은 ROLLBACK;
  - COMMIT: 위에서 작업한 것을 실제 DB에 적용
  - ROLLBACK: 위에서 작업한 것을 무시하고 버림

```sql
USE sqldb;

-- 트랜잭션을 시작. (자바에서 할 떄는 다르게 할 것)
START TRANSACTION; 
SELECT * FROM buytbl; -- SELECT는 보통 트랜잭션을 걸지 않지만 테스트 용도
DELETE FROM buytbl;
ROLLBACK;
-- COMMMIT문 혹은 ROLLBACK문이 나오면 트랜잭션 종료

SELECT * FROM buytbl;
-- 실행 결과
-- ROLLBACK 했으므로 데이터가 삭제되지 않음
```

이후 자바 프로그램에서 JDBC를 사용할 때 다시 사용하게 된다. 실제 자바 코드로는 다른 방법으로 트랜잭션을 설정하므로, START TRANSACTION 구문은 다시 사용할 일이 없을 것이다.